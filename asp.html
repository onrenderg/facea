@{
ViewBag.Title = "Passport Photo Capture";
Layout = "~/Views/Shared/_LayoutPublic.cshtml";
}

<style>
    /* ... (Your existing loader styles) ... */
    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loader-box {
        background: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        text-align: center;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #ddd;
        border-top: 4px solid #2a7fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
</style>

<script src="~/js/face-api.min.js"></script>

<h2>Passport Photo Capture</h2>

<div class="alert alert-primary text-center">
    <strong>Live Photo Capture</strong><br />
    Roll No: @ViewBag.RollNo
</div>

<div style="position:relative; width:350px; margin:auto;">
    <input type="hidden" id="hdn_imgvector" value="" />

    <!-- Direct Video Feed -->
    <video id="video" autoplay playsinline
        style="width: 350px; height: 450px; object-fit: cover; background: black;"></video>

    <!-- Simple Frame (Optional) -->
    <div
        style="position:absolute; top:60px; left:60px; width:225px; height:300px; border:2px solid #00ff00; border-radius:8px; pointer-events:none;">
    </div>
</div>

<div style="text-align:center; margin-top:15px;">
    <button id="captureBtn" class="btn btn-primary">Capture & Process</button>
    <button id="saveBtn" class="btn btn-success" disabled>Save Photo</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<div id="loader" class="loader-overlay" style="display:none;">
    <div class="loader-box">
        <div class="spinner"></div>
        <div class="loader-text">Processing Face Data...</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const hdnVector = document.getElementById('hdn_imgvector');
    const saveBtn = document.getElementById('saveBtn');

    // 1. Load models once and start camera
    async function init() {
        showLoader();
        const MODEL_URL = '@Url.Action("FaceModel", "UpdateProfile", new { area = "ApplicantRegistration" })' + '?file=';

        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        } catch (err) {
            alert("Error initializing: " + err.message);
        } finally {
            hideLoader();
        }
    }

    // 2. Direct Video Element Processing
    document.getElementById("captureBtn").addEventListener("click", async function () {
        if (video.videoWidth === 0) return alert("Camera not ready");

        showLoader();
        try {
            // PASS VIDEO ELEMENT DIRECTLY!
            const detection = await faceapi
                .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (!detection) {
                alert("No face detected! Please center your face in the frame.");
                return;
            }

            // Save vector
            hdnVector.value = JSON.stringify(Array.from(detection.descriptor));

            // Draw current frame to canvas just for saving
            canvas.width = 350;
            canvas.height = 450;
            canvas.getContext('2d').drawImage(video, 0, 0, 350, 450);

            alert("Face detected successfully!");
            saveBtn.disabled = false;

        } catch (err) {
            console.error(err);
            alert("Processing error");
        } finally {
            hideLoader();
        }
    });

    // 3. Save Logic
    saveBtn.addEventListener("click", function () {
        const payload = {
            imageBase64: canvas.toDataURL("image/png"),
            RollNo: "@ViewBag.RollNo",
            Id: "@ViewBag.Id",
            hdn_imgvector: hdnVector.value
        };

        fetch('@Url.Action("SavePhoto","Camera", new { area= "ApplicantRegistration" })', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) location.reload();
            });
    });

    function showLoader() { document.getElementById("loader").style.display = "flex"; }
    function hideLoader() { document.getElementById("loader").style.display = "none"; }

    init(); // Start everything
</script>